# Swagger first template with Swagger Inflector 
A template project for creating swagger first APIs in java. Use it as a starting point for your API.

The project uses [Spring Boot](https://projects.spring.io/spring-boot) and [Swagger Inflector](https://github.com/swagger-api/swagger-inflector) to serve the API defined in your swagger specification. 
Models are generated at build time from the swagger specification using the [swagger-codegen-maven-plugin](https://github.com/swagger-api/swagger-codegen/tree/master/modules/swagger-codegen-maven-plugin).

The template API consists of a ping-endpoint, with integration tests, to demonstrate Swagger Inflector and code generation of models:

`/api/ping?message=Hello`

To demonstrate Swagger Inflector's ability to mock unimplemented APIs defined in the swagger specification, the specification also contains an unimplemented endpoint `/api/messages`. 

**Philosophy**:
* All API structures and data formats are mastered and maintained in the swagger specification: `src/main/resources/public/api.yml`
* Business logic is developed by creating spring beans backing the API served by the Swagger Inflector Servlet 
* Add services, domain classes and data access logic as needed 

## Build
`mvn clean package`

## Run

`java -jar target/swagger-first-template-java-inflector.jar`

or

`mvn spring-boot:run`

or simply run the `no.nc.Main` from your IDE.

## Live visual documentation
Live documentation of the running API is available at the root. I.e: 

<http://localhost:8080/>

A webjar containing [Swagger UI](https://swagger.io/tools/swagger-ui/) is bundled with the project and is pointed to the swagger specification served by Swagger Inflector.

## Live Swagger documentation
Swagger Inflector makes the swagger specification available here:

<http://localhost:8080/api/swagger.json>

The handwritten swagger specification is made available at this endpoint:

<http://localhost:8080/api.yml>

(Note: The basepath of the handwritten swagger is not correct in this setup, due to the way Swagger Inflector works when operating with a rootPath.)

## Where can I look at the generated models?
The models are generated at build time here:

`target/generated-sources/swagger/src/gen`

## How Swagger Inflector maps API endpoints to your Spring Beans

Swagger Inflector has serveral strategies for finding the bean backing an endpoint. The recommended approach, as shown below, is an explicit mapping using properties in the swagger specification.

The swagger specification names the class and method implementing the controller: 
```
  ...
  /ping:
    get:
      x-swagger-router-controller: no.nc.ping.PingController
      operationId: getPing
      ...
```

The implementing bean simply follows the mapping from the specification:

```java
package no.nc.ping;

import ...

@Component
public class PingController {

    public ResponseContext getPing(RequestContext context, String message) {
        return new ResponseContext()
                .status(Response.Status.OK)
                .entity(new Pong()
                        .message(message)
                        .dateAndTime(OffsetDateTime.now()));
    }
}
```

Note: 
* Methods should return a `ResponseContext`, and the first argument should be a `RequestContext`. Generated models should be used in the method signature where applicable.
* These beans should NOT be annotated as `@Controllers`! Swagger Inflector uses them as POJOs.

## Developing APIs based on this template
Typical workflow when working with APIs and data formats:
1. Change the swagger specification: `src/main/resources/public/api.yml`
2. Regenerate models: `mvn clean package`
3. Resolve potential compilations errors due to changes
4. Implement new business logic by creating Spring Beans matching the class defined by `x-swagger-router-controller` and method defined by `operationId` in the swagger specification
    * Do not forget to add `@Component` to controller classes
    
Rinse and repeat...

## Tips and tricks
* In development mode the Swagger Inflector will give status on unimplemented endpoints here: <http://localhost:8080/api/debug.json>
* Mark the directory `target/generated-sources/swagger/src/gen/java` as a generated sources root in your IDE if it is not done automatically
* Web-based swagger editors can be used to edit the swagger specification. E.g. <http://editor2.swagger.io>
* Zalando has made a decent IntelliJ swagger editor with code completion: <https://github.com/zalando/intellij-swagger>

## Gotchas
* Swagger inflector will only parse the body of a request if the Content-Type header is set
* Do not forget to add `@Component` to controller classes
    * These are NOT Spring `@Controllers`!
* In this setup the basepath in the api.yml is not accurate. Use the swagger.json generated by Swagger Inflector to get the correct basepath
* Swagger Inflector uses Jersey 2 (and not SpringMVC). To make this work with Spring Boot, the application has two servlets running. The standard spring dispatcherServlet mapped at `/`, and the inflector servlet, using Jersey 2, mapped at `/api`.